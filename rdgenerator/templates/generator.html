<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>RustDesk 客户端构建器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-bg: #0a0e27;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --neon-blue: #00d4ff;
            --neon-purple: #bc13fe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* 动态背景 */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(188, 19, 254, 0.1) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 粒子效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }

        /* 标题区域 */
        .header-section {
            text-align: center;
            padding: 40px 20px;
            position: relative;
        }

        .main-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-shadow: 0 0 80px rgba(102, 126, 234, 0.5);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* 卡片样式 */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px 0 rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .card-header-custom {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--card-border);
        }

        .card-header-custom i {
            font-size: 1.8rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-header-custom h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* 表单元素 */
        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 1rem;
            display: block;
        }

        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text-primary);
            padding: 14px 20px;
            font-size: 1rem;
            line-height: 1.6;
            width: 100%;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            color: var(--text-primary);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        /* 表单组间距 */
        .mb-3 {
            margin-bottom: 1.5rem !important;
        }

        .glass-card .mb-3:last-child {
            margin-bottom: 0 !important;
        }

        /* textarea 样式 */
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* 高级设置中的 textarea 更小 */
        textarea#id_defaultManual,
        textarea#id_overrideManual {
            min-height: 50px;
            font-size: 0.9rem;
            padding: 10px 15px;
            line-height: 1.4;
        }

        /* 高级设置卡片更紧凑 */
        .glass-card:has(#id_defaultManual) {
            padding: 20px 28px;
        }

        .glass-card:has(#id_defaultManual) .mb-3 {
            margin-bottom: 0.8rem !important;
        }

        .glass-card:has(#id_defaultManual) .form-label {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .glass-card:has(#id_defaultManual) .card-header-custom {
            margin-bottom: 20px;
            padding-bottom: 15px;
        }

        .glass-card:has(#id_defaultManual) .row.g-2 {
            margin-bottom: 0.5rem;
        }

        /* 权限控制卡片稍微增加间距 */
        .glass-card:has(#id_permissionsType) .row.g-2 {
            row-gap: 0.6rem;
        }

        /* 高级设置按钮区域 */
        .glass-card:has(#id_defaultManual) .text-center {
            margin-top: 0.5rem;
        }

        .glass-card:has(#id_defaultManual) .row.g-2.mb-3 {
            margin-bottom: 0.5rem !important;
        }

        /* 帮助文本样式 */
        .form-text, small.text-muted {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 8px;
            display: block;
            line-height: 1.5;
        }

        /* 复选框样式 */
        .form-check-input {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            cursor: pointer;
        }

        .form-check-input:checked {
            background: var(--primary-gradient);
            border-color: var(--neon-blue);
        }

        .form-check-label {
            color: var(--text-secondary);
            margin-left: 10px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .form-check-label:hover {
            color: var(--text-primary);
        }

        /* 平台图标 */
        .platform-icons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .platform-icon-wrapper {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .platform-icon {
            font-size: 3.5rem;
            color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0));
        }

        .platform-icon-wrapper:hover .platform-icon {
            color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
            filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));
        }

        .platform-icon-wrapper.active .platform-icon {
            color: var(--neon-blue);
            transform: scale(1.15);
            filter: drop-shadow(0 0 30px var(--neon-blue));
        }

        .platform-name {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .platform-icon-wrapper.active .platform-name {
            opacity: 1;
            transform: translateY(0);
        }

        .platform-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--secondary-gradient);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(245, 87, 108, 0.5);
        }

        /* 按钮样式 */
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 15px 50px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .btn-gradient:active {
            transform: translateY(-1px);
        }

        .btn-gradient i {
            margin-right: 10px;
        }

        /* 保存/加载配置 */
        .save-load-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .save-load-btn {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 12px 25px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .save-load-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        /* 帮助提示 */
        .help-tip {
            display: inline-block;
            margin-left: 10px;
            color: var(--neon-blue);
            cursor: help;
            font-size: 0.9rem;
        }

        .help-tip:hover {
            color: var(--neon-purple);
        }

        /* 警告提示 */
        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #ffc107;
        }

        .warning-box i {
            margin-right: 10px;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .main-title {
                font-size: 2.5rem;
            }

            .platform-icons {
                gap: 20px;
            }

            .platform-icon {
                font-size: 2.5rem;
            }

            .glass-card {
                padding: 20px;
            }
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gradient);
        }

        /* 特殊效果 */
        .neon-text {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .feature-badge {
            display: inline-block;
            background: var(--success-gradient);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 15px;
            margin-left: 10px;
        }

        /* Loading动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div class="particles" id="particles"></div>

    <div class="container-fluid px-4">
        <!-- 头部 -->
        <div class="header-section">
            <h1 class="main-title">
                <i class="fas fa-robot"></i> RustDesk 客户端构建器
            </h1>
            <p class="subtitle">
                <i class="fas fa-magic"></i> 定制您的专属远程桌面客户端
            </p>
        </div>

        <!-- 保存/加载配置 -->
        <div class="save-load-container">
            <button type="button" class="save-load-btn me-2" onclick="saveFormData()">
                <i class="fas fa-save"></i> 保存配置
            </button>
            <button type="button" class="save-load-btn" onclick="loadFormData()">
                <i class="fas fa-folder-open"></i> 加载配置
            </button>
            <input type="file" id="fileInput" style="display:none;" accept=".json">
        </div>

        <form id="myForm" action="/generator" method="post" enctype="multipart/form-data">
            {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>表单验证失败！</strong>
                    {% for field, errors in form.errors.items %}
                        <br>{{ field }}: {{ errors|first }}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}

            <div class="row g-4">
                <!-- 平台选择 -->
                <div class="col-12">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-laptop-code"></i>
                            <h2>选择构建平台</h2>
                        </div>

                        <div class="platform-icons">
                            <div class="platform-icon-wrapper active" data-platform="windows">
                                <div style="position: relative;">
                                    <i class="fab fa-windows platform-icon"></i>
                                    <span class="platform-badge">64</span>
                                </div>
                                <span class="platform-name">Windows 64位</span>
                            </div>
                            <div class="platform-icon-wrapper" data-platform="windows-x86">
                                <div style="position: relative;">
                                    <i class="fab fa-windows platform-icon"></i>
                                    <span class="platform-badge">32</span>
                                </div>
                                <span class="platform-name">Windows 32位</span>
                            </div>
                            <div class="platform-icon-wrapper" data-platform="linux">
                                <i class="fab fa-linux platform-icon"></i>
                                <span class="platform-name">Linux</span>
                            </div>
                            <div class="platform-icon-wrapper" data-platform="android">
                                <i class="fab fa-android platform-icon"></i>
                                <span class="platform-name">Android</span>
                            </div>
                            <div class="platform-icon-wrapper" data-platform="macos">
                                <i class="fab fa-apple platform-icon"></i>
                                <span class="platform-name">macOS</span>
                            </div>
                        </div>

                        <input type="hidden" name="platform" id="id_platform" value="windows">

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="id_version" class="form-label">
                                    RustDesk 版本
                                    <span class="help-tip" title="选择要构建的 RustDesk 版本">
                                        <i class="fas fa-question-circle"></i>
                                    </span>
                                </label>
                                {{ form.version }}
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    {{ form.ui_mode }}
                                    <label class="form-check-label" for="{{ form.ui_mode.id_for_label }}">
                                        {{ form.ui_mode.label }}
                                        <span class="feature-badge">推荐</span>
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.delayFix }}
                                    <label class="form-check-label" for="{{ form.delayFix.id_for_label }}">
                                        {{ form.delayFix.label }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="warning-box">
                            <i class="fas fa-info-circle"></i>
                            部分功能以 Windows 64 位系统为基准适配，其他平台可能无法完全生效
                        </div>
                    </div>
                </div>

                <!-- 第一行：通用设置 & 服务器配置 -->
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-cog"></i>
                            <h2>通用设置</h2>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.exename.id_for_label }}" class="form-label">
                                配置名称 <span class="neon-text">*</span>
                            </label>
                            {{ form.exename }}
                            <div id="filenameError" class="text-danger small mt-1"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.appname.id_for_label }}" class="form-label">应用名称</label>
                            {{ form.appname }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.slogan.id_for_label }}" class="form-label">自定义标语</label>
                            {{ form.slogan }}
                            <small class="form-text text-muted">留空则使用默认标语</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.androidappid.id_for_label }}" class="form-label">安卓客户端标识符</label>
                            {{ form.androidappid }}
                            <small class="form-text text-muted">默认: com.carriez.flutter_hbb</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">客户端类型</label>
                            <div>
                                {% for radio in form.direction %}
                                    <div class="form-check">
                                        {{ radio.tag }}
                                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.installation.id_for_label }}" class="form-label">安装行为</label>
                            {{ form.installation }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.settings.id_for_label }}" class="form-label">设置权限</label>
                            {{ form.settings }}
                        </div>

                        <!-- 细粒度设置控制 -->
                        <div id="granular-settings" style="display: none;" class="mt-3 p-3" style="background: rgba(255, 255, 255, 0.02); border-radius: 10px;">
                            <h6 class="neon-text mb-3">
                                <i class="fas fa-sliders-h"></i> 细粒度设置控制
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideGeneralSettings }}
                                        <label class="form-check-label" for="{{ form.hideGeneralSettings.id_for_label }}">
                                            隐藏常规设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideSecuritySettings }}
                                        <label class="form-check-label" for="{{ form.hideSecuritySettings.id_for_label }}">
                                            隐藏安全设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideNetworkSettings }}
                                        <label class="form-check-label" for="{{ form.hideNetworkSettings.id_for_label }}">
                                            隐藏网络设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideDisplaySettings }}
                                        <label class="form-check-label" for="{{ form.hideDisplaySettings.id_for_label }}">
                                            隐藏显示设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideAccountSettings }}
                                        <label class="form-check-label" for="{{ form.hideAccountSettings.id_for_label }}">
                                            隐藏账户设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hidePluginSettings }}
                                        <label class="form-check-label" for="{{ form.hidePluginSettings.id_for_label }}">
                                            隐藏插件设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideRemotePrinterSettings }}
                                        <label class="form-check-label" for="{{ form.hideRemotePrinterSettings.id_for_label }}">
                                            隐藏远程打印设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideServerSettings }}
                                        <label class="form-check-label" for="{{ form.hideServerSettings.id_for_label }}">
                                            隐藏服务器设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideProxySettings }}
                                        <label class="form-check-label" for="{{ form.hideProxySettings.id_for_label }}">
                                            隐藏代理设置
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.hideWebsocketSettings }}
                                        <label class="form-check-label" for="{{ form.hideWebsocketSettings.id_for_label }}">
                                            隐藏 WebSocket 设置
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-server"></i>
                            <h2>服务器配置</h2>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.serverIP.id_for_label }}" class="form-label">服务器地址</label>
                            {{ form.serverIP }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.key.id_for_label }}" class="form-label">密钥</label>
                            {{ form.key }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.apiServer.id_for_label }}" class="form-label">API 地址</label>
                            {{ form.apiServer }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.urlLink.id_for_label }}" class="form-label">门户网站</label>
                            {{ form.urlLink }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.downloadLink.id_for_label }}" class="form-label">更新下载链接</label>
                            {{ form.downloadLink }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.updateLink.id_for_label }}" class="form-label">在线更新链接</label>
                            {{ form.updateLink }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.compname.id_for_label }}" class="form-label">公司名称</label>
                            {{ form.compname }}
                        </div>
                    </div>
                </div>

                <!-- 第二行：安全设置 & 外观设置 -->
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-shield-alt"></i>
                            <h2>安全设置</h2>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.passApproveMode.id_for_label }}" class="form-label">认证方式</label>
                            {{ form.passApproveMode }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.permanentPassword.id_for_label }}" class="form-label">预设密码</label>
                            {{ form.permanentPassword }}
                            <div id="passwordRequirement" class="warning-box mt-2" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                使用隐藏连接窗口功能时，请设置预设密码
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.unlockPin.id_for_label }}" class="form-label">配置PIN</label>
                            {{ form.unlockPin }}
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.denyLan }}
                                    <label class="form-check-label" for="{{ form.denyLan.id_for_label }}">
                                        隐藏于局域网
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.enableDirectIP }}
                                    <label class="form-check-label" for="{{ form.enableDirectIP.id_for_label }}">
                                        启用IP访问
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.autoClose }}
                                    <label class="form-check-label" for="{{ form.autoClose.id_for_label }}">
                                        自动关闭会话
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideSecuritySettings }}
                                    <label class="form-check-label" for="{{ form.hideSecuritySettings.id_for_label }}">
                                        隐藏安全设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideNetworkSettings }}
                                    <label class="form-check-label" for="{{ form.hideNetworkSettings.id_for_label }}">
                                        隐藏网络设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideServerSettings }}
                                    <label class="form-check-label" for="{{ form.hideServerSettings.id_for_label }}">
                                        隐藏服务器设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideRemotePrinterSettings }}
                                    <label class="form-check-label" for="{{ form.hideRemotePrinterSettings.id_for_label }}">
                                        隐藏远程打印设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hide_account }}
                                    <label class="form-check-label" for="{{ form.hide_account.id_for_label }}">
                                        隐藏账户设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.remove_preset_password_warning }}
                                    <label class="form-check-label" for="{{ form.remove_preset_password_warning.id_for_label }}">
                                        隐藏密码警告
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideProxySettings }}
                                    <label class="form-check-label" for="{{ form.hideProxySettings.id_for_label }}">
                                        隐藏代理设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hideWebsocketSettings }}
                                    <label class="form-check-label" for="{{ form.hideWebsocketSettings.id_for_label }}">
                                        隐藏 WebSocket 设置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    {{ form.hidecm }}
                                    <label class="form-check-label" for="{{ form.hidecm.id_for_label }}">
                                        隐藏连接管理窗口
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-palette"></i>
                            <h2>外观设置</h2>
                        </div>

                        {{ form.iconbase64.as_hidden }}
                        {{ form.logobase64.as_hidden }}
                        {{ form.privacy_wallpaper_base64.as_hidden }}

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.iconfile.id_for_label }}" class="form-label">应用图标（PNG）</label>
                                {{ form.iconfile }}
                                <div id="icon-preview" class="mt-2"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.logofile.id_for_label }}" class="form-label">品牌标识（PNG）</label>
                                {{ form.logofile }}
                                <div id="logo-preview" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.privacy_wallpaper.id_for_label }}" class="form-label">
                                隐私模式背景图
                                <span class="feature-badge">新</span>
                            </label>
                            {{ form.privacy_wallpaper }}
                            <small class="form-text text-muted">推荐 1920×1080，最大 500KB</small>
                            <div id="privacy-wallpaper-preview" class="mt-2"></div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.theme.id_for_label }}" class="form-label">主题</label>
                                {{ form.theme }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.themeDorO.id_for_label }}" class="form-label">设置模式</label>
                                {{ form.themeDorO }}
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.image_quality.id_for_label }}" class="form-label">图像质量</label>
                                {{ form.image_quality }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.custom_fps.id_for_label }}" class="form-label">帧率</label>
                                {{ form.custom_fps }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第三行：权限控制 & 高级设置 -->
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-lock"></i>
                            <h2>权限控制</h2>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.permissionsDorO.id_for_label }}" class="form-label">权限模式</label>
                                {{ form.permissionsDorO }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.permissionsType.id_for_label }}" class="form-label">权限预设</label>
                                {{ form.permissionsType }}
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableKeyboard }}
                                    <label class="form-check-label" for="{{ form.enableKeyboard.id_for_label }}">
                                        启用键盘控制
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableClipboard }}
                                    <label class="form-check-label" for="{{ form.enableClipboard.id_for_label }}">
                                        启用剪贴板同步
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableFileTransfer }}
                                    <label class="form-check-label" for="{{ form.enableFileTransfer.id_for_label }}">
                                        启用文件传输
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableAudio }}
                                    <label class="form-check-label" for="{{ form.enableAudio.id_for_label }}">
                                        启用音频传输
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableTCP }}
                                    <label class="form-check-label" for="{{ form.enableTCP.id_for_label }}">
                                        启用 TCP 隧道
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableRemoteRestart }}
                                    <label class="form-check-label" for="{{ form.enableRemoteRestart.id_for_label }}">
                                        启用远程重启
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableRecording }}
                                    <label class="form-check-label" for="{{ form.enableRecording.id_for_label }}">
                                        启用会话录制
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableBlockingInput }}
                                    <label class="form-check-label" for="{{ form.enableBlockingInput.id_for_label }}">
                                        启用输入锁定
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableRemoteModi }}
                                    <label class="form-check-label" for="{{ form.enableRemoteModi.id_for_label }}">
                                        允许远程修改配置
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enablePrinter }}
                                    <label class="form-check-label" for="{{ form.enablePrinter.id_for_label }}">
                                        启用远程打印
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableCamera }}
                                    <label class="form-check-label" for="{{ form.enableCamera.id_for_label }}">
                                        启用摄像头访问
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.enableTerminal }}
                                    <label class="form-check-label" for="{{ form.enableTerminal.id_for_label }}">
                                        启用终端访问
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-tools"></i>
                            <h2>高级设置</h2>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.removeWallpaper }}
                                    <label class="form-check-label" for="{{ form.removeWallpaper.id_for_label }}">
                                        移除桌面壁纸
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.defaultManual.id_for_label }}" class="form-label">
                                默认设置（用户可修改）
                                <span class="help-tip" title="每行一个设置，格式: key=value">
                                    <i class="fas fa-question-circle"></i>
                                </span>
                            </label>
                            {{ form.defaultManual }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.overrideManual.id_for_label }}" class="form-label">
                                覆盖设置（用户不可修改）
                                <span class="help-tip" title="每行一个设置，格式: key=value">
                                    <i class="fas fa-question-circle"></i>
                                </span>
                            </label>
                            {{ form.overrideManual }}
                        </div>

                        <div class="text-center">
                            <a href="https://rustdesk.com/docs/zh-cn/self-host/client-configuration/advanced-settings/"
                               target="_blank"
                               class="btn btn-sm save-load-btn">
                                <i class="fas fa-book"></i> 查看高级设置文档
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 附加功能 -->
                <div class="col-12">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <i class="fas fa-star"></i>
                            <h2>附加功能</h2>
                        </div>

                        <!-- 主控端功能 -->
                        <div class="mb-4">
                            <h5 class="neon-text mb-3">
                                <i class="fas fa-desktop"></i> 主控端功能
                            </h5>
                            <div class="row g-2">
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.cycleMonitor }}
                                        <label class="form-check-label" for="{{ form.cycleMonitor.id_for_label }}">
                                            显示器切换按钮
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.xOffline }}
                                        <label class="form-check-label" for="{{ form.xOffline.id_for_label }}">
                                            标记离线设备
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hide_chat_voice }}
                                        <label class="form-check-label" for="{{ form.hide_chat_voice.id_for_label }}">
                                            隐藏聊天与语音
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.viewOnly }}
                                        <label class="form-check-label" for="{{ form.viewOnly.id_for_label }}">
                                            默认浏览模式
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.collapse_toolbar }}
                                        <label class="form-check-label" for="{{ form.collapse_toolbar.id_for_label }}">
                                            自动折叠工具栏
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.privacy_mode }}
                                        <label class="form-check-label" for="{{ form.privacy_mode.id_for_label }}">
                                            默认隐私模式
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hide_username_on_card }}
                                        <label class="form-check-label" for="{{ form.hide_username_on_card.id_for_label }}">
                                            隐藏用户名
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 被控端功能 -->
                        <div class="mb-4">
                            <h5 class="neon-text mb-3">
                                <i class="fas fa-laptop"></i> 被控端功能
                            </h5>
                            <div class="row g-2">
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hideTray }}
                                        <label class="form-check-label" for="{{ form.hideTray.id_for_label }}">
                                            隐藏托盘图标
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hidePassword }}
                                        <label class="form-check-label" for="{{ form.hidePassword.id_for_label }}">
                                            隐藏临时密码面板
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hideMenuBar }}
                                        <label class="form-check-label" for="{{ form.hideMenuBar.id_for_label }}">
                                            隐藏设置菜单
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hideQuit }}
                                        <label class="form-check-label" for="{{ form.hideQuit.id_for_label }}">
                                            隐藏退出按钮
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.addcopy }}
                                        <label class="form-check-label" for="{{ form.addcopy.id_for_label }}">
                                            添加复制按钮
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.applyprivacy }}
                                        <label class="form-check-label" for="{{ form.applyprivacy.id_for_label }}">
                                            禁止退出隐私模式
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.passpolicy }}
                                        <label class="form-check-label" for="{{ form.passpolicy.id_for_label }}">
                                            允许简单密码
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.allowHostnameAsId }}
                                        <label class="form-check-label" for="{{ form.allowHostnameAsId.id_for_label }}">
                                            主机名作为 ID
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hideService_Start_Stop }}
                                        <label class="form-check-label" for="{{ form.hideService_Start_Stop.id_for_label }}">
                                            隐藏服务启停
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 通用功能 -->
                        <div class="mb-4">
                            <h5 class="neon-text mb-3">
                                <i class="fas fa-globe"></i> 通用功能
                            </h5>
                            <div class="row g-2">
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.disable_check_update }}
                                        <label class="form-check-label" for="{{ form.disable_check_update.id_for_label }}">
                                            禁用检查更新
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.no_uninstall }}
                                        <label class="form-check-label" for="{{ form.no_uninstall.id_for_label }}">
                                            不创建卸载快捷方式
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.disable_install }}
                                        <label class="form-check-label" for="{{ form.disable_install.id_for_label }}">
                                            生成便携版
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.allowD3dRender }}
                                        <label class="form-check-label" for="{{ form.allowD3dRender.id_for_label }}">
                                            Direct3D 渲染
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.use_texture_render }}
                                        <label class="form-check-label" for="{{ form.use_texture_render.id_for_label }}">
                                            纹理渲染
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.pre_elevate_service }}
                                        <label class="form-check-label" for="{{ form.pre_elevate_service.id_for_label }}">
                                            自动提权
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.sync_init_clipboard }}
                                        <label class="form-check-label" for="{{ form.sync_init_clipboard.id_for_label }}">
                                            同步初始剪贴板
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.hide_powered_by_me }}
                                        <label class="form-check-label" for="{{ form.hide_powered_by_me.id_for_label }}">
                                            隐藏技术支持标识
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.statussort }}
                                        <label class="form-check-label" for="{{ form.statussort.id_for_label }}">
                                            允许状态排序
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 col-lg-3">
                                    <div class="form-check">
                                        {{ form.removeNewVersionNotif }}
                                        <label class="form-check-label" for="{{ form.removeNewVersionNotif.id_for_label }}">
                                            移除版本更新通知
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="col-12 text-center mb-5">
                    <button type="submit" class="btn-gradient">
                        <i class="fas fa-rocket"></i> 开始构建客户端
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 生成粒子
        function createParticles() {
            const particles = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 5) + 's';
                particles.appendChild(particle);
            }
        }

        createParticles();

        // 平台图标切换
        document.querySelectorAll('.platform-icon-wrapper').forEach(wrapper => {
            wrapper.addEventListener('click', function() {
                document.querySelectorAll('.platform-icon-wrapper').forEach(w => w.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('id_platform').value = this.dataset.platform;
            });
        });

        // 图片预览
        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 100px; border-radius: 10px; border: 2px solid rgba(0, 212, 255, 0.3);">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('{{ form.iconfile.id_for_label }}').addEventListener('change', function(e) {
            previewImage(e.target, 'icon-preview');
        });

        document.getElementById('{{ form.logofile.id_for_label }}').addEventListener('change', function(e) {
            previewImage(e.target, 'logo-preview');
        });

        document.getElementById('{{ form.privacy_wallpaper.id_for_label }}').addEventListener('change', function(e) {
            previewImage(e.target, 'privacy-wallpaper-preview');
        });

        // 隐藏连接窗口检测
        document.getElementById('{{ form.hidecm.id_for_label }}').addEventListener('change', function() {
            const passwordReq = document.getElementById('passwordRequirement');
            const passField = document.getElementById('{{ form.permanentPassword.id_for_label }}');
            const passMode = document.getElementById('{{ form.passApproveMode.id_for_label }}');

            if (this.checked) {
                passwordReq.style.display = 'block';
                passField.focus();
                passMode.value = 'password';
            } else {
                passwordReq.style.display = 'none';
                passMode.value = 'password-click';
            }
        });

        // 细粒度设置控制显示/隐藏
        document.getElementById('id_settings').addEventListener('change', function() {
            const granularDiv = document.getElementById('granular-settings');
            granularDiv.style.display = this.value === 'settingsGranular' ? 'block' : 'none';
        });

        // 权限预设控制
        const permissionCheckboxes = [
            '{{ form.enableKeyboard.id_for_label }}',
            '{{ form.enableClipboard.id_for_label }}',
            '{{ form.enableFileTransfer.id_for_label }}',
            '{{ form.enableAudio.id_for_label }}',
            '{{ form.enableTCP.id_for_label }}',
            '{{ form.enableRemoteRestart.id_for_label }}',
            '{{ form.enableRecording.id_for_label }}',
            '{{ form.enableBlockingInput.id_for_label }}',
            '{{ form.enableRemoteModi.id_for_label }}',
            '{{ form.enablePrinter.id_for_label }}',
            '{{ form.enableCamera.id_for_label }}',
            '{{ form.enableTerminal.id_for_label }}'
        ];

        document.getElementById('{{ form.permissionsType.id_for_label }}').addEventListener('change', function() {
            permissionCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (this.value === 'full') {
                    checkbox.checked = true;
                    checkbox.disabled = true;
                } else if (this.value === 'view') {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                } else {
                    checkbox.disabled = false;
                }
            });
        });

        // 图像质量和帧率联动
        const fpsSelect = document.getElementById('{{ form.custom_fps.id_for_label }}');
        const qualitySelect = document.getElementById('{{ form.image_quality.id_for_label }}');

        fpsSelect.addEventListener('change', function() {
            const fps = parseInt(this.value);
            if ([60, 90, 120].includes(fps)) {
                qualitySelect.value = 'custom';
            }
        });

        // 保存配置
        async function saveFormData() {
            const filename = document.getElementById('{{ form.exename.id_for_label }}').value;
            if (!filename) {
                document.getElementById('filenameError').textContent = '配置名称不能为空';
                return;
            }

            const formData = {};
            const form = document.getElementById('myForm');
            const formDataObj = new FormData(form);

            formDataObj.forEach((value, key) => {
                formData[key] = value;
            });

            form.querySelectorAll('select').forEach(select => {
                formData[select.name] = select.value;
            });

            form.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                if (input.name) {
                    if (input.type === 'radio') {
                        if (input.checked) {
                            formData[input.name] = input.value;
                        }
                    } else {
                        formData[input.name] = input.checked;
                    }
                }
            });

            // 处理图片
            const iconPreview = document.getElementById('icon-preview');
            if (iconPreview.firstChild && iconPreview.firstChild.src) {
                formData.iconfile = iconPreview.firstChild.src;
            }

            const logoPreview = document.getElementById('logo-preview');
            if (logoPreview.firstChild && logoPreview.firstChild.src) {
                formData.logofile = logoPreview.firstChild.src;
            }

            const privacyPreview = document.getElementById('privacy-wallpaper-preview');
            if (privacyPreview.firstChild && privacyPreview.firstChild.src) {
                formData.privacy_wallpaper = privacyPreview.firstChild.src;
            }

            const jsonData = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 加载配置
        function loadFormData() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const formData = JSON.parse(e.target.result);
                            for (const key in formData) {
                                const elements = document.querySelectorAll(`[name="${key}"], [id="${key}"]`);
                                if (elements.length > 0) {
                                    elements.forEach(element => {
                                        if (element.type === 'radio') {
                                            if (element.value === String(formData[key])) {
                                                element.checked = true;
                                            }
                                        } else if (element.type === 'checkbox') {
                                            element.checked = Boolean(formData[key]);
                                        } else if (element.type !== 'file') {
                                            element.value = formData[key];
                                        }

                                        // 图片预览
                                        if (key === 'iconfile' && formData[key]) {
                                            document.getElementById('icon-preview').innerHTML = `<img src="${formData[key]}" style="max-width: 200px; max-height: 100px; border-radius: 10px; border: 2px solid rgba(0, 212, 255, 0.3);">`;
                                        }
                                        if (key === 'logofile' && formData[key]) {
                                            document.getElementById('logo-preview').innerHTML = `<img src="${formData[key]}" style="max-width: 200px; max-height: 100px; border-radius: 10px; border: 2px solid rgba(0, 212, 255, 0.3);">`;
                                        }
                                        if (key === 'privacy_wallpaper' && formData[key]) {
                                            document.getElementById('privacy-wallpaper-preview').innerHTML = `<img src="${formData[key]}" style="max-width: 200px; max-height: 100px; border-radius: 10px; border: 2px solid rgba(0, 212, 255, 0.3);">`;
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            alert('加载配置失败：无效的 JSON 文件');
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        // 客户端类型变化时禁用/启用主控端功能
        document.querySelectorAll('[name="direction"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isIncoming = this.value === 'incoming';
                const controllerFields = [
                    '{{ form.viewOnly.id_for_label }}',
                    '{{ form.cycleMonitor.id_for_label }}',
                    '{{ form.xOffline.id_for_label }}',
                    '{{ form.hide_chat_voice.id_for_label }}',
                    '{{ form.privacy_mode.id_for_label }}',
                    '{{ form.collapse_toolbar.id_for_label }}',
                    '{{ form.hide_username_on_card.id_for_label }}'
                ];

                controllerFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.disabled = isIncoming;
                        if (isIncoming) field.checked = false;
                    }
                });
            });
        });

        // 更新链接联动
        const downloadLinkInput = document.getElementById('{{ form.downloadLink.id_for_label }}');
        const updateLinkInput = document.getElementById('{{ form.updateLink.id_for_label }}');
        const disableCheckUpdate = document.getElementById('{{ form.disable_check_update.id_for_label }}');

        function updateCheckUpdateState() {
            if (downloadLinkInput.value.trim() || updateLinkInput.value.trim()) {
                disableCheckUpdate.checked = false;
                disableCheckUpdate.disabled = true;
            } else {
                disableCheckUpdate.disabled = false;
            }
        }

        downloadLinkInput?.addEventListener('input', updateCheckUpdateState);
        updateLinkInput?.addEventListener('input', updateCheckUpdateState);

        // 初始化
        updateCheckUpdateState();
    </script>
</body>
</html>
